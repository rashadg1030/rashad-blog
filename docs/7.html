<!DOCTYPE html>
<html>

<head>
    <meta content="width=device-width, initial-scale=1" name="viewport" charset="utf-8">
    <link href="./style.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Nunito|Raleway" rel="stylesheet">
    <title>Guide to Implementing Custom Monadic Effects in Issue-Wanted</title>

    <!-- Twitter cards -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@GoverRashad" />
    <meta property="twitter:title" content="rashadのblog - Guide to Implementing Custom Monadic Effects in Issue-Wanted"/>
    <meta name="twitter:description" content="A post on adding a custom monad to the issue-wanted project" />
    <meta name="twitter:image:src" content="https://rashadg1030.github.io/img/education-graphing.jpg" />
    <meta property="og:title" content="rashadのblog - Guide to Implementing Custom Monadic Effects in Issue-Wanted" />
    <meta property="og:description" content="A post on adding a custom monad to the issue-wanted project" />
    <meta property="og:site_name" content="rashadのblog" />
    <meta property="og:image" content="https://rashadg1030.github.io/img/education-graphing.jpg" />
</head>

<body>
    <div class="navbar"><a href="./index.html" class="navbar-item">data Rashad</a><span> = </span><a
            href="./software.html" class="navbar-item">Software</a><span> | </span><a href="./research.html"
            class="navbar-item">Research</a><span> | </span><a href="./library.html"
            class="navbar-item">Library</a><span> | </span><a href="./art.html" class="navbar-item">Art</a><span> |
        </span><a href="./contact.html" class="navbar-item">Contact {..}</a></div>
    <div class="main">
        <h1 class=post-title>Guide to Implementing Custom Monadic Effects in Issue-Wanted</h1>
        <p class=post-date>2019-07-13</p>
        <hr>
<p>Over the past few weeks I’ve been making steady progress on the <a href="https://github.com/kowainik/issue-wanted">issue-wanted</a> project I’m working on for Google Summer of Code 2019. Today I would like to present my work on adding a custom monad/effect to issue-wanted and what I learned during the process. Before I go on about what I added, lets explore what I started with.</p>
<h2 id="the-app-monad-and-readert-design-pattern">The App Monad and ReaderT Design Pattern</h2>
<p>As I said in my last post there is still an ongoing debate on what is the best way to structure Haskell programs. As far as I know, the most popular method used today is monad transformers, also known as “mtl-style”. Monad transformers give the programmer the ability to combine, or stack, different monads together to create a monad that suits their specific needs. You’ve probably learned of the idea that monads can be thought of as computations or actions, each with a specific set of rules on how to compose them[1]. I like to think of monads as powerups in a video game; each one gives the program a unique ability. At the core of issue-wanted is the <code>App</code> monad. It is a basic monad stack defined as follows:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource haskell numberLines"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" title="1"><span class="co">-- | Main application monad.</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">newtype</span> <span class="dt">App</span> a <span class="ot">=</span> <span class="dt">App</span></a>
<a class="sourceLine" id="cb1-3" title="3">    {<span class="ot"> unApp ::</span> <span class="dt">ReaderT</span> <span class="dt">AppEnv</span> <span class="dt">IO</span> a</a>
<a class="sourceLine" id="cb1-4" title="4">    } <span class="kw">deriving</span> (<span class="dt">Functor</span>, <span class="dt">Applicative</span>, <span class="dt">Monad</span>, <span class="dt">MonadIO</span>, <span class="dt">MonadReader</span> <span class="dt">AppEnv</span>, <span class="dt">MonadUnliftIO</span>)</a></code></pre></div>
<p>I’m using the <a href="https://hackage.haskell.org/package/transformers-0.5.6.2/docs/Control-Monad-Trans-Reader.html#t:ReaderT"><code>ReaderT</code></a> monad transformer in combination with the <code>IO</code> monad. This is just the <code>Reader</code> monad with the addition of being able to use <code>IO</code> in its computations. The <code>ReaderT</code> transformer is wrapped in a newtype, <code>App</code> in this case, so we can inherit useful methods from other typeclasses as well.</p>
<p>In short, the type definition above means <code>App</code> is a monad that can read from an environment of type <code>AppEnv</code> and return values of type <code>a</code> in an <code>IO</code> context. Note the various typeclasses that <code>App</code> derives. <code>App</code> has access to methods ranging from the useful basics like <code>fmap</code> (from <code>Functor</code>), to more powerful methods like <code>liftIO</code> (from <code>MonadIO</code>) and <code>ask</code> (from <code>MonadReader AppEnv</code>).</p>
<p>This way of structuring an application around the <code>ReaderT</code> monad transformer is based on the <a href="https://www.fpcomplete.com/blog/2017/06/readert-design-pattern">ReaderT design pattern</a>[2], made popular by Michael Snoyman at FPComplete. If you think about it, an application runs in a context where:</p>
<ol type="1">
<li>It has access to an envrionment (in our case, the <code>AppEnv</code> type) where it can retrieve neccessary resources like a database connection, a configuration file, TLS manager, etc.</li>
</ol>
<p>and</p>
<ol start="2" type="1">
<li>Can perform input/output (i.e. writing to a database or downloading a file from the Internet)</li>
</ol>
<p>The <code>ReaderT</code> monad transfomer in combination with the <code>IO</code> monad allows us to express this in our program.</p>
<h2 id="handling-errors">Handling Errors</h2>
<p>Wait, how does the <code>App</code> monad handle errors? There are multiple ways to throw and catch errors in Haskell, all with different tradeoffs. One option is to add the <code>ExceptT</code> monad transformer to the <code>App</code> monad stack, but this complicates the code. If possible, it is best to try and avoid adding another layer to your monad stack. Using <code>ExceptT</code> also prevents the <code>App</code> monad from derivng important typeclasses like <code>MonadUnliftIO</code> that we need for concurrency.</p>
<p>Instead, an instance of <code>MonadError</code> is implemented for the the <code>App</code> monad.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource haskell numberLines"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" title="1"><span class="co">{- | Exception wrapper around &#39;AppError&#39;. Useful when you need to throw/catch</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="co">&#39;AppError&#39; as &#39;Exception&#39;.</span></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="co">-}</span></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="kw">newtype</span> <span class="dt">AppException</span> <span class="ot">=</span> <span class="dt">AppException</span></a>
<a class="sourceLine" id="cb2-5" title="5">    {<span class="ot"> unAppException ::</span> <span class="dt">AppError</span></a>
<a class="sourceLine" id="cb2-6" title="6">    } <span class="kw">deriving</span> (<span class="dt">Show</span>)</a>
<a class="sourceLine" id="cb2-7" title="7">      <span class="kw">deriving</span> anyclass (<span class="dt">Exception</span>)</a>
<a class="sourceLine" id="cb2-8" title="8"></a>
<a class="sourceLine" id="cb2-9" title="9"><span class="kw">instance</span> <span class="dt">MonadError</span> <span class="dt">AppError</span> <span class="dt">App</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb2-10" title="10"><span class="ot">    throwError ::</span> <span class="dt">AppError</span> <span class="ot">-&gt;</span> <span class="dt">App</span> a</a>
<a class="sourceLine" id="cb2-11" title="11">    throwError <span class="ot">=</span> liftIO <span class="op">.</span> throwIO <span class="op">.</span> <span class="dt">AppException</span></a>
<a class="sourceLine" id="cb2-12" title="12">    <span class="ot">{-# INLINE throwError #-}</span></a>
<a class="sourceLine" id="cb2-13" title="13"></a>
<a class="sourceLine" id="cb2-14" title="14"><span class="ot">    catchError ::</span> <span class="dt">App</span> a <span class="ot">-&gt;</span> (<span class="dt">AppError</span> <span class="ot">-&gt;</span> <span class="dt">App</span> a) <span class="ot">-&gt;</span> <span class="dt">App</span> a</a>
<a class="sourceLine" id="cb2-15" title="15">    catchError action handler <span class="ot">=</span> <span class="dt">App</span> <span class="op">$</span> <span class="dt">ReaderT</span> <span class="op">$</span> \env <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb2-16" title="16">        <span class="kw">let</span> ioAction <span class="ot">=</span> runApp env action</a>
<a class="sourceLine" id="cb2-17" title="17">        ioAction <span class="ot">`catch`</span> \(<span class="dt">AppException</span> e) <span class="ot">-&gt;</span> runApp env <span class="op">$</span> handler e</a>
<a class="sourceLine" id="cb2-18" title="18">    <span class="ot">{-# INLINE catchError #-}</span></a></code></pre></div>
<p>The <code>AppException</code> newtype deriving the <a href="https://hackage.haskell.org/package/base-4.12.0.0/docs/Control-Exception.html#t:Exception"><code>Exception</code></a> typeclass is used to make implementing <code>MonadError</code> for the <code>App</code> monad a lot easier and performant. The reasons for choosing this technique to handle errors in the <code>App</code> monad is more complicated than I describe here, but I will save this lesson for another blog post.</p>
<h2 id="appenv-and-the-has-typeclass-pattern">AppEnv and The Has Typeclass Pattern</h2>
<p>To get a better understanding of how the <code>ReaderT</code> monad is being utilized in issue-wanted, lets take a look at the <code>AppEnv</code> type that defines the environment the <code>App</code> monad has access to:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource haskell numberLines"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" title="1"><span class="co">-- 1</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="kw">type</span> <span class="dt">AppEnv</span> <span class="ot">=</span> <span class="dt">Env</span> <span class="dt">App</span></a>
<a class="sourceLine" id="cb3-3" title="3"></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="co">-- 2</span></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="kw">type</span> <span class="dt">DbPool</span> <span class="ot">=</span> <span class="dt">Pool</span> <span class="dt">Connection</span></a>
<a class="sourceLine" id="cb3-6" title="6"></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="co">-- 3</span></a>
<a class="sourceLine" id="cb3-8" title="8"><span class="kw">data</span> <span class="dt">Env</span> (<span class="ot">m ::</span> <span class="dt">Type</span> <span class="ot">-&gt;</span> <span class="dt">Type</span>) <span class="ot">=</span> <span class="dt">Env</span></a>
<a class="sourceLine" id="cb3-9" title="9">    {<span class="ot"> envDbPool    ::</span> <span class="op">!</span><span class="dt">DbPool</span></a>
<a class="sourceLine" id="cb3-10" title="10">    ,<span class="ot"> envLogAction ::</span> <span class="op">!</span>(<span class="dt">LogAction</span> m <span class="dt">Message</span>)</a>
<a class="sourceLine" id="cb3-11" title="11">    }</a>
<a class="sourceLine" id="cb3-12" title="12"></a>
<a class="sourceLine" id="cb3-13" title="13"><span class="co">-- 4</span></a>
<a class="sourceLine" id="cb3-14" title="14"><span class="kw">instance</span> <span class="dt">HasLog</span> (<span class="dt">Env</span> m) <span class="dt">Message</span> m <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-15" title="15"><span class="ot">    getLogAction ::</span> <span class="dt">Env</span> m <span class="ot">-&gt;</span> <span class="dt">LogAction</span> m <span class="dt">Message</span></a>
<a class="sourceLine" id="cb3-16" title="16">    getLogAction <span class="ot">=</span> envLogAction</a>
<a class="sourceLine" id="cb3-17" title="17"></a>
<a class="sourceLine" id="cb3-18" title="18"><span class="ot">    setLogAction ::</span> <span class="dt">LogAction</span> m <span class="dt">Message</span> <span class="ot">-&gt;</span> <span class="dt">Env</span> m <span class="ot">-&gt;</span> <span class="dt">Env</span> m</a>
<a class="sourceLine" id="cb3-19" title="19">    setLogAction newAction env <span class="ot">=</span> env { envLogAction <span class="ot">=</span> newAction }</a>
<a class="sourceLine" id="cb3-20" title="20"></a>
<a class="sourceLine" id="cb3-21" title="21"><span class="co">-- 5</span></a>
<a class="sourceLine" id="cb3-22" title="22"><span class="kw">class</span> <span class="dt">Has</span> field env <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-23" title="23"><span class="ot">    obtain ::</span> env <span class="ot">-&gt;</span> field</a>
<a class="sourceLine" id="cb3-24" title="24"></a>
<a class="sourceLine" id="cb3-25" title="25"><span class="co">-- 6</span></a>
<a class="sourceLine" id="cb3-26" title="26"><span class="kw">instance</span> <span class="dt">Has</span> <span class="dt">DbPool</span>                (<span class="dt">Env</span> m) <span class="kw">where</span> obtain <span class="ot">=</span> envDbPool</a>
<a class="sourceLine" id="cb3-27" title="27"><span class="kw">instance</span> <span class="dt">Has</span> (<span class="dt">LogAction</span> m <span class="dt">Message</span>) (<span class="dt">Env</span> m) <span class="kw">where</span> obtain <span class="ot">=</span> envLogAction</a>
<a class="sourceLine" id="cb3-28" title="28"></a>
<a class="sourceLine" id="cb3-29" title="29"><span class="co">-- 7</span></a>
<a class="sourceLine" id="cb3-30" title="30"><span class="ot">grab ::</span> <span class="kw">forall</span> field env m <span class="op">.</span> (<span class="dt">MonadReader</span> env m, <span class="dt">Has</span> field env) <span class="ot">=&gt;</span> m field</a>
<a class="sourceLine" id="cb3-31" title="31">grab <span class="ot">=</span> asks <span class="op">$</span> obtain <span class="op">@</span>field</a></code></pre></div>
<p>Ok lets break this down step by step:</p>
<ol type="1">
<li><p>We have the type synonym <code>AppEnv</code> that you saw in the definition of the <code>App</code> monad above. It’s just the <code>Env</code> type parameterized by the <code>App</code> type. One interesting thing to notice is that <code>AppEnv</code> is used to define <code>App</code> and <code>App</code> is used to define <code>AppEnv</code> making these definitions mutually recursive.</p></li>
<li><p><code>DbPool</code> is the type synonym we’re using to represent a pool of database connections. This will be used for connecting to our PostgreSQL database.</p></li>
<li><p>This is the <code>Env</code> type. It’s a record type that represents the different resources our <code>App</code> monad has access to. Interestingly, it has a type variable of kind <code>Type -&gt; Type</code>[3] meaning <code>m</code> must be filled in by a type that takes another type. This type variable is primarily used for the <code>LogAction</code> type from the <a href="http://hackage.haskell.org/package/co-log"><code>co-log</code></a> library.</p></li>
<li><p>An instance of the <code>HasLog</code> typeclass from the <code>co-log</code> library for our <code>Env</code> type.</p></li>
<li><p>The <code>Has</code> typeclass. It is parameterized by two type variables; the <code>field</code> of interest and the <code>env</code> it is retrieved from. It only has one method, <code>obtain</code>, which takes a value of type <code>env</code> and gives back a value of type <code>field</code>. This is an example of the <a href="https://medium.com/hackernoon/%20the-has-type-class-pattern-ca12adab70ae">Has typeclass pattern</a>. This pattern is commonly used in conjuction with the ReaderT design pattern to make it even more clean and extensible.</p></li>
<li><p>Here are our instances of the <code>Has</code> typeclass. We add one for each field in the <code>Env</code> type. The two definintions basically mean we have a way of obtaining a <code>DbPool</code> and <code>LogAction</code> from our <code>Env</code> type.</p></li>
<li><p>This interesting function, <code>grab</code>, does exactly what its name implies. It “grabs” a value of the specified type from our environment. It can be used to grab our database pool for example:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource haskell numberLines"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" title="1"><span class="co">-- | Perform action that needs database connection.</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="ot">withPool ::</span> <span class="dt">WithDb</span> env m <span class="ot">=&gt;</span> (<span class="dt">Sql.Connection</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> b) <span class="ot">-&gt;</span> m b</a>
<a class="sourceLine" id="cb4-3" title="3">withPool f <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb4-4" title="4">    pool <span class="ot">&lt;-</span> grab <span class="op">@</span><span class="dt">DbPool</span></a>
<a class="sourceLine" id="cb4-5" title="5">    liftIO <span class="op">$</span> Pool.withResource pool f</a>
<a class="sourceLine" id="cb4-6" title="6"><span class="ot">{-# INLINE withPool #-}</span></a></code></pre></div>
<p><code>@DbPool</code> is an example of a type application which you can read more about <a href="">here</a>. I like to think of the <code>grab</code> function as a more convenient version of <code>ask</code> that allows you to specify exactly what you want from the environment.</p></li>
</ol>
<h2 id="the-download-monad">The Download Monad</h2>
<p>With the power to mix and match different monads comes the responsibility of building your own custom monad. When we need to operate within a certain context, but the available monads don’t describe it well enough, we need to create our own.</p>
<p>If you don’t know already, issue-wanted is a web application that programmers can use to quickly find open-source Haskell projects to contribute to. Me and my mentors want to make sure that people are able to find the right project for them, and so we thought displaying the Haskell repository along with the category names that populate the project’s <code>.cabal</code> file would be a nice feature. Creators of Haskell projects have the option to add a comma-seperated list of values to the <code>category</code> field of their <code>.cabal</code> file. Here’s the <code>category</code> field for the issue-wanted project for example:</p>
<pre class="cabal"><code>category: Web, Application</code></pre>
<p>Our challenge was to figure out how to fetch this metadata and store it in our database. An easy solution would’ve been to just use the GitHub API to retrieve the file contents, but we already use the GitHub API pretty extensively throughout other parts of the application and thought we might risk going over the API rate-limit. We decided to implement a function to download the file directly from the URL.</p>
<p>We knew we could construct a URL for the <code>.cabal</code> file given a <code>RepoOwner</code> and <code>RepoName</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource haskell numberLines"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" title="1"><span class="co">-- | This function returns a @Url@ for downloading a @Repo@&#39;s @.cabal@ file.</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="ot">repoCabalUrl ::</span> <span class="dt">RepoOwner</span> <span class="ot">-&gt;</span> <span class="dt">RepoName</span> <span class="ot">-&gt;</span> <span class="dt">Url</span></a>
<a class="sourceLine" id="cb6-3" title="3">repoCabalUrl (<span class="dt">RepoOwner</span> repoOwner) (<span class="dt">RepoName</span> repoName) <span class="ot">=</span> <span class="dt">Url</span> <span class="op">$</span></a>
<a class="sourceLine" id="cb6-4" title="4">    <span class="st">&quot;https://raw.githubusercontent.com/&quot;</span></a>
<a class="sourceLine" id="cb6-5" title="5">    <span class="op">&lt;&gt;</span> repoOwner</a>
<a class="sourceLine" id="cb6-6" title="6">    <span class="op">&lt;&gt;</span> <span class="st">&quot;/&quot;</span></a>
<a class="sourceLine" id="cb6-7" title="7">    <span class="op">&lt;&gt;</span> repoName</a>
<a class="sourceLine" id="cb6-8" title="8">    <span class="op">&lt;&gt;</span> <span class="st">&quot;/master/&quot;</span></a>
<a class="sourceLine" id="cb6-9" title="9">    <span class="op">&lt;&gt;</span> repoName</a>
<a class="sourceLine" id="cb6-10" title="10">    <span class="op">&lt;&gt;</span> <span class="st">&quot;.cabal&quot;</span></a></code></pre></div>
<p>This solution isn’t one hundered percent correct because there will be cases where the <code>.cabal</code> file isn’t stored on GitHub at all, the <code>.cabal</code> file isn’t in the <code>master</code> branch, or we’re dealing with a multi-package Haskell project. For now, we’re ignoring these cases, but we definitely plan on adding support for these kinds of Haskell projects in the future to ensure that we have as much useful metadata as possible.</p>
<p>Once we figured out how to construct the URLs, we needed to implement a function for downloading the contents. A function that takes a <code>Url</code> and gives back a <code>ByteString</code> representing the file contents:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource haskell numberLines"><code class="sourceCode haskell"><a class="sourceLine" id="cb7-1" title="1"><span class="ot">downloadFile ::</span> <span class="dt">Url</span> <span class="ot">-&gt;</span> <span class="dt">ByteString</span></a></code></pre></div>
<p>But downloading a file from the Internet is not a pure function! <code>downloadFile</code> needs to operate within some sort of monadic context:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource haskell numberLines"><code class="sourceCode haskell"><a class="sourceLine" id="cb8-1" title="1"><span class="ot">downloadFile ::</span> (<span class="dt">SomeContext</span> m) <span class="ot">=&gt;</span> <span class="dt">Url</span> <span class="ot">-&gt;</span> m <span class="dt">ByteString</span></a></code></pre></div>
<p>We named this context <code>MonadDownload</code>. The class definition looks like this:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource haskell numberLines"><code class="sourceCode haskell"><a class="sourceLine" id="cb9-1" title="1"><span class="co">-- | Describes a monad that can download files from a given @Url@.</span></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="kw">class</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">MonadDownload</span> m <span class="kw">where</span></a>
<a class="sourceLine" id="cb9-3" title="3"><span class="ot">    downloadFile ::</span> <span class="dt">Url</span> <span class="ot">-&gt;</span> m <span class="dt">ByteString</span></a></code></pre></div>
<p>Typeclasses like the one above are a great way to decouple our code and take advantage of things like mock instances for testing.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource haskell numberLines"><code class="sourceCode haskell"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">instance</span> <span class="dt">MonadDownload</span> <span class="dt">Test</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb10-2" title="2"><span class="ot">    downloadFile ::</span> <span class="dt">Url</span> <span class="ot">-&gt;</span> <span class="dt">Test</span> <span class="dt">ByteString</span></a>
<a class="sourceLine" id="cb10-3" title="3">    downloadFile url <span class="ot">=</span> <span class="op">...</span></a></code></pre></div>
<p>I haven’t done this for issue-wanted becasue we are using other techniques to test the <code>downloadFile</code> function, but the fact that I can implement this, or any other version of the interface, if I need to is very nice.</p>
<p>More importantly, I needed to implement an instance of <code>MonadDownload</code> for the <code>App</code> monad; the heart of our application.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource haskell numberLines"><code class="sourceCode haskell"><a class="sourceLine" id="cb11-1" title="1"><span class="co">-- 1</span></a>
<a class="sourceLine" id="cb11-2" title="2"><span class="kw">instance</span> <span class="dt">MonadDownload</span> <span class="dt">App</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb11-3" title="3">    downloadFile <span class="ot">=</span> downloadFileImpl</a>
<a class="sourceLine" id="cb11-4" title="4"></a>
<a class="sourceLine" id="cb11-5" title="5"><span class="co">-- 2</span></a>
<a class="sourceLine" id="cb11-6" title="6"><span class="kw">type</span> <span class="dt">WithDownload</span> env m <span class="ot">=</span> (<span class="dt">MonadIO</span> m, <span class="dt">MonadReader</span> env m, <span class="dt">WithError</span> m, <span class="dt">WithLog</span> env m)</a>
<a class="sourceLine" id="cb11-7" title="7"></a>
<a class="sourceLine" id="cb11-8" title="8"><span class="co">-- 3</span></a>
<a class="sourceLine" id="cb11-9" title="9"><span class="ot">downloadFileImpl ::</span> <span class="dt">WithDownload</span> env m <span class="ot">=&gt;</span> <span class="dt">Url</span> <span class="ot">-&gt;</span> m <span class="dt">ByteString</span></a>
<a class="sourceLine" id="cb11-10" title="10">downloadFileImpl url<span class="op">@</span><span class="dt">Url</span>{<span class="op">..</span>} <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb11-11" title="11">    man <span class="ot">&lt;-</span> newTlsManager</a>
<a class="sourceLine" id="cb11-12" title="12">    <span class="kw">let</span> req <span class="ot">=</span> fromString <span class="op">$</span> toString unUrl</a>
<a class="sourceLine" id="cb11-13" title="13">    <span class="fu">log</span> <span class="dt">I</span> <span class="op">$</span> <span class="st">&quot;Attempting to download file from &quot;</span> <span class="op">&lt;&gt;</span> unUrl <span class="op">&lt;&gt;</span> <span class="st">&quot; ...&quot;</span></a>
<a class="sourceLine" id="cb11-14" title="14">    response <span class="ot">&lt;-</span> liftIO <span class="op">$</span> httpLbs req man</a>
<a class="sourceLine" id="cb11-15" title="15">    <span class="kw">let</span> status <span class="ot">=</span> statusCode <span class="op">$</span> responseStatus response</a>
<a class="sourceLine" id="cb11-16" title="16">    <span class="kw">let</span> body <span class="ot">=</span> responseBody response</a>
<a class="sourceLine" id="cb11-17" title="17">    <span class="fu">log</span> <span class="dt">D</span> <span class="op">$</span> <span class="st">&quot;Recieved a status code of &quot;</span> <span class="op">&lt;&gt;</span> <span class="fu">show</span> status <span class="op">&lt;&gt;</span> <span class="st">&quot; from &quot;</span> <span class="op">&lt;&gt;</span> unUrl</a>
<a class="sourceLine" id="cb11-18" title="18">    <span class="kw">case</span> status <span class="kw">of</span></a>
<a class="sourceLine" id="cb11-19" title="19">        <span class="dv">200</span> <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb11-20" title="20">            <span class="fu">log</span> <span class="dt">I</span> <span class="op">$</span> <span class="st">&quot;Successfully downloaded file from &quot;</span> <span class="op">&lt;&gt;</span> unUrl</a>
<a class="sourceLine" id="cb11-21" title="21">            <span class="fu">pure</span> <span class="op">$</span> toStrict body</a>
<a class="sourceLine" id="cb11-22" title="22">        _   <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb11-23" title="23">            <span class="fu">log</span> <span class="dt">E</span> <span class="op">$</span> <span class="st">&quot;Couldn&#39;t download file from &quot;</span> <span class="op">&lt;&gt;</span> unUrl</a>
<a class="sourceLine" id="cb11-24" title="24">            throwError <span class="op">$</span> urlDownloadFailedError url</a></code></pre></div>
<p>Let’s break this down:</p>
<ol type="1">
<li><p>You may be wondering why <code>downloadFile</code> is being implemented via the <code>downloadFileImpl</code> function below it. The type of <code>downloadFile</code> is constrained to <code>Url -&gt; App     ByteString</code> so we can only use it in the <code>App</code> context. <code>downloadFileImpl</code> on the other hand can operated within a polymorphic context <code>m</code>, as long as it abides by the <code>WithDownload</code> constraint. This is useful because it helps with code readability and reusablity. We can see exactly what effects are used by <code>downloadFileImpl</code> by looking at the type signature, and other instances of <code>MonadDownload</code> (like the one for the <code>Test</code> monad we saw above) can reuse <code>downloadFileImpl</code> if we want to keep the same logic for downloading files.</p></li>
<li><p>Something that stands out in this snippet of code is the <code>WithDownload</code> type synonym. Prior to working on issue-wanted, I didn’t know that that you could define type synonyms for constraints but it turns out to be a pretty useful technique.</p></li>
<li><p>Finally, the actual implementation of <code>downloadFile</code>. After asking around on <a href="https://www.reddit.com/r/haskell/comments/cavfnh/%20recommended_library_for_downloading_files_via/">r/haskell</a> for a library that would allow us to idiomatically download files from URLs, we decided to use the <a href="">http-client</a> and <a href="https://hackage.haskell.org/package/http-client-tls">http-client-tls</a> libraries. We’re using <code>newTlsManager</code> for loading up a new TLS manager and <code>httpLbs</code> for making the request. We use the response status code for logging messages and return the response body.</p></li>
</ol>
<p>Awesome! We have our very own monad for downloading stuff from URLs! But wait…</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode numberSource haskell numberLines"><code class="sourceCode haskell"><a class="sourceLine" id="cb12-1" title="1"><span class="ot">downloadFileImpl ::</span> <span class="dt">WithDownload</span> env m <span class="ot">=&gt;</span> <span class="dt">Url</span> <span class="ot">-&gt;</span> m <span class="dt">ByteString</span></a>
<a class="sourceLine" id="cb12-2" title="2">downloadFileImpl url<span class="op">@</span><span class="dt">Url</span>{<span class="op">..</span>} <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb12-3" title="3">    man <span class="ot">&lt;-</span> newTlsManager</a>
<a class="sourceLine" id="cb12-4" title="4">    <span class="op">...</span></a></code></pre></div>
<p>A new TLS manager has to be created each time we call <code>downloadFileImpl</code>. This is unneccessary and can lead to suboptimal performance, so we decided to add a field for the manager to our <code>Env</code> record. This way, we only need to create the manager once when the application is started, and grab the same one each time we need to download a file.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode numberSource haskell numberLines"><code class="sourceCode haskell"><a class="sourceLine" id="cb13-1" title="1"><span class="kw">data</span> <span class="dt">Env</span> (<span class="ot">m ::</span> <span class="dt">Type</span> <span class="ot">-&gt;</span> <span class="dt">Type</span>) <span class="ot">=</span> <span class="dt">Env</span></a>
<a class="sourceLine" id="cb13-2" title="2">    {<span class="ot"> envDbPool    ::</span> <span class="op">!</span><span class="dt">DbPool</span></a>
<a class="sourceLine" id="cb13-3" title="3">    ,<span class="ot"> envManager   ::</span> <span class="op">!</span><span class="dt">Manager</span></a>
<a class="sourceLine" id="cb13-4" title="4">    ,<span class="ot"> envLogAction ::</span> <span class="op">!</span>(<span class="dt">LogAction</span> m <span class="dt">Message</span>)</a>
<a class="sourceLine" id="cb13-5" title="5">    }</a>
<a class="sourceLine" id="cb13-6" title="6"></a>
<a class="sourceLine" id="cb13-7" title="7"><span class="kw">instance</span> <span class="dt">Has</span> <span class="dt">Manager</span> (<span class="dt">Env</span> m) <span class="kw">where</span> obtain <span class="ot">=</span> envManager</a></code></pre></div>
<p>Now <code>downloadFileImpl</code> looks like this:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode numberSource haskell numberLines"><code class="sourceCode haskell"><a class="sourceLine" id="cb14-1" title="1"><span class="ot">downloadFileImpl ::</span> <span class="dt">WithDownload</span> env m <span class="ot">=&gt;</span> <span class="dt">Url</span> <span class="ot">-&gt;</span> m <span class="dt">ByteString</span></a>
<a class="sourceLine" id="cb14-2" title="2">downloadFileImpl url<span class="op">@</span><span class="dt">Url</span>{<span class="op">..</span>} <span class="ot">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb14-3" title="3">    man <span class="ot">&lt;-</span> grab <span class="op">@</span><span class="dt">Manager</span></a>
<a class="sourceLine" id="cb14-4" title="4">    <span class="kw">let</span> req <span class="ot">=</span> fromString <span class="op">$</span> toString unUrl</a>
<a class="sourceLine" id="cb14-5" title="5">    <span class="fu">log</span> <span class="dt">I</span> <span class="op">$</span> <span class="st">&quot;Attempting to download file from &quot;</span> <span class="op">&lt;&gt;</span> unUrl <span class="op">&lt;&gt;</span> <span class="st">&quot; ...&quot;</span></a>
<a class="sourceLine" id="cb14-6" title="6">    response <span class="ot">&lt;-</span> liftIO <span class="op">$</span> httpLbs req man</a>
<a class="sourceLine" id="cb14-7" title="7">    <span class="kw">let</span> status <span class="ot">=</span> statusCode <span class="op">$</span> responseStatus response</a>
<a class="sourceLine" id="cb14-8" title="8">    <span class="kw">let</span> body <span class="ot">=</span> responseBody response</a>
<a class="sourceLine" id="cb14-9" title="9">    <span class="fu">log</span> <span class="dt">D</span> <span class="op">$</span> <span class="st">&quot;Recieved a status code of &quot;</span> <span class="op">&lt;&gt;</span> <span class="fu">show</span> status <span class="op">&lt;&gt;</span> <span class="st">&quot; from &quot;</span> <span class="op">&lt;&gt;</span> unUrl</a>
<a class="sourceLine" id="cb14-10" title="10">    <span class="kw">case</span> status <span class="kw">of</span></a>
<a class="sourceLine" id="cb14-11" title="11">        <span class="dv">200</span> <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb14-12" title="12">            <span class="fu">log</span> <span class="dt">I</span> <span class="op">$</span> <span class="st">&quot;Successfully downloaded file from &quot;</span> <span class="op">&lt;&gt;</span> unUrl</a>
<a class="sourceLine" id="cb14-13" title="13">            <span class="fu">pure</span> <span class="op">$</span> toStrict body</a>
<a class="sourceLine" id="cb14-14" title="14">        _   <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb14-15" title="15">            <span class="fu">log</span> <span class="dt">E</span> <span class="op">$</span> <span class="st">&quot;Couldn&#39;t download file from &quot;</span> <span class="op">&lt;&gt;</span> unUrl</a>
<a class="sourceLine" id="cb14-16" title="16">            throwError <span class="op">$</span> urlDownloadFailedError url</a></code></pre></div>
<p>Now, the manager is only created once and is grabbed from the envrionment anytime it’s needed to download a file. Nice!</p>
<h2 id="conclusion">Conclusion</h2>
<p>Issue-wanted is looking better and better as the Summer goes on, and I’m excited to see what it will become. Up until the past couple of weeks, most of the code in issue-wanted was borrowed from the Holmusk <a href="https://github.com/Holmusk/three-layer">three-layer</a> template project and I haven’t really got the opportunity to implement anything unique to issue-wanted. This is rapidly starting to change as I move past building the foundation and work my way into the more interesting features, like the one I wrote about in this post, that will make issue-wanted what it is.</p>
<h2 id="footnotes">Footnotes:</h2>
<p>[1] From what I’ve heard, the analogy between monads and “computations” or “actions” isn’t 100% accurate, especially in the mathematical sense, but this is how I reason about monads. It has been a useful model for me so far.</p>
<p>[2] The ReaderT pattern used in issue-wanted and the three-layer template project is a slightly modified version of the classic ReaderT pattern by Michael Snoyman.</p>
<p>[3] https://en.wikibooks.org/wiki/Haskell/Monad_transformers</p>
    </div>
    <!-- <div class="footer">
        <hr>
        <p>This is a footer.</p>
    </div> -->

</body>

</html>